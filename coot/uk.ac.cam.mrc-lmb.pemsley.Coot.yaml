app-id: uk.ac.cam.mrc_lmb.pemsley.Coot
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: coot
finish-args:
  - --share=network
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --filesystem=host

modules:
  - name: boost
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --with-python=/app
      - ./b2 install --prefix=/app
    sources:
      - type: archive
        url: https://boostorg.jfrog.io/artifactory/main/release/1.79.0/source/boost_1_79_0.tar.gz
        sha256: 273f1be93238a068aba4f9735a4a2b003019af067b9c183ed227780b8f36062c

  # - name: boost-python3
  #   buildsystem: simple
  #   build-commands:
  #     - ./bootstrap.sh
  #     - ./b2 install --with-python --prefix=/app
  #   sources:
  #     - type: archive
  #       url: https://boostorg.jfrog.io/artifactory/main/release/1.79.0/source/boost_1_79_0.tar.gz
  #       sha256: 273f1be93238a068aba4f9735a4a2b003019af067b9c183ed227780b8f36062c

  - name: fftw2
    buildsystem: autotools
    sources:
      - type: archive
        url: https://fftw.org/fftw-2.1.5.tar.gz
        sha256: f8057fae1c7df8b99116783ef3e94a6a44518d49c72e2e630c24b689c6022630
    config-opts:
      - --enable-shared
      - --enable-float
      - --disable-static
    build-commands:
      - |
        if [ "$(uname -m)" = "aarch64" ]; then
          sed -i 's/-flat_namespace -undefined suppress/-undefined dynamic_lookup/g' configure
        fi
        ./configure --prefix=/app --enable-shared --enable-float --disable-static
        make
        make install

  - name: mmdb2
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/mmdb2-2.0.22.tar.gz
        sha256: a9646933ce9f34633e1ae4901f2383af0e5318d6490851328f5b6aa06195ab51
    config-opts:
      - --enable-shared
      - --disable-static
    build-options:
      env:
        CXXFLAGS: "-g -O2"
    build-commands:
      - |
        ./configure --prefix=/app --enable-shared --disable-static
        make
        make install

  - name: libccp4
    buildsystem: simple
    config-opts:
      - --prefix=/app
      - --enable-shared
      - --disable-static
      - --disable-fortran
    sources:
      - type: archive
        url: https://github.com/cctbx/ccp4io/archive/b58c4fb68902e4e6a58f4a585d0722e542516076.tar.gz
        sha256: f1edc5a830cd4a078eae700e14b1d89612fb7a12318094363642340aafe41af6

    build-options:
      - -I${FLATPAK_BUILDIR}/libccp4/lib
      - -L${FLATPAK_DEST}/lib

    build-commands:
      - |
        cd libccp4
        ./configure --prefix=${FLATPAK_DEST} --enable-shared --disable-static --disable-fortran
        make
        make install

    test-commands:
      - |
        if ! pkg-config --cflags libccp4c | grep -q "-I${FLATPAK_DEST}/include"; then
          echo "libccp4c not found in pkg-config"
          exit 1
        fi

  - name: clipper4coot
    buildsystem: autotools
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/clipper-2.1.20180802.tar.gz
        sha256: 7c7774f224b59458e0faa104d209da906c129523fa737e81eb3b99ec772b81e0
      - type: patch
        path: ./clipper-configure-2.patch
        sha256: 3cf0a68163451773e9764c11c740fcbd1a91daf9d5782d94049b90f3cd1fe5ae

    dependencies:
      - fftw2
      - mmdb2
      - libccp4

    config-opts:
      - --enable-mmdb
      - --enable-ccp4
      - --enable-cif
      - --enable-minimol
      - --enable-cns
      - --enable-shared
      - --disable-static

    build-options:
      cxxflags: "-g -O2 -fno-strict-aliasing -Wno-narrowing"
      env:
        LDFLAGS: "-L/app/lib"
        CPPFLAGS: "-I/app/include"

    build-commands:
      - |
        export CXXFLAGS="-g -O2 -fno-strict-aliasing -Wno-narrowing"
        export LDFLAGS="-L${FLATPAK_DEST}/usr/lib/fftw2/lib"
        export CPPFLAGS="-I${FLATPAK_DEST}/usr/include/fftw2"

        # Configure and build Clipper4coot
        ./configure --prefix=/app --enable-mmdb --enable-ccp4 --enable-cif --enable-minimol --enable-cns --enable-shared --disable-static
        make
        make install

  - name: gemmi
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/project-gemmi/gemmi/archive/refs/tags/v0.6.7.tar.gz
        sha256: f3dd7c3aac0b01f0338ff5034c11be0e7b23639f018c8d6b1db7cc9d77a8dee9
    build-commands:
      - mkdir build
      - cmake -S . -B build -DCMAKE_INSTALL_PREFIX=/app
      - cmake --build build
      - cmake --install build

  # # テストデータリソースを追加
  # - name: testdata
  #   buildsystem: simple
  #   sources:
  #     - type: archive
  #       url: https://raw.githubusercontent.com/project-gemmi/gemmi/master/tests/5i55.cif
  #       sha256: cae937745acc22d1c3bdd21cc6fa3c36a3d9f271494c22e3e3a3ce512c72fb1d

  - name: libgd
    buildsystem: autotools
    config-opts:
      - --prefix=/app
      - --with-fontconfig=/app
      - --with-freetype=/app
      - --with-jpeg=/app
      - --with-avif=/app
      - --with-png=/app
      - --with-tiff=/app
      - --with-webp=/app
      - --without-x
      - --without-xpm
    sources:
      - type: archive
        url: https://github.com/libgd/libgd/releases/download/gd-2.3.3/libgd-2.3.3.tar.xz
        sha256: 3fe822ece20796060af63b7c60acb151e5844204d289da0ce08f8fdf131e5a61
      - type: patch
        path: f4bc1f5.patch
        sha256sum: 1015f6e125f139a1e922ac4bc2a18abbc498b0142193fa692846bf0f344a3691

    build-options:
      env:
        CFLAGS: "-I/app/include"
        LDFLAGS: "-L/app/lib"

    build-commands:
      - ./configure --prefix=/app --with-fontconfig=/app --with-freetype=/app --with-jpeg=/app --with-avif=/app --with-png=/app --with-tiff=/app --with-webp=/app --without-x --without-xpm
      - make
      - make install

  - name: raster3d
    buildsystem: simple
    sources:
      - type: archive
        url: http://www.bmsc.washington.edu/raster3d/Raster3D_3.0-7.tar.gz
        sha256: f566b499fee341db3a95229672c6afdbdb69da7faabdbe34f6e0d332d766160c
    build-commands:
      - |
        export CFLAGS="-I${FLATPAK_DEST}/include"
        export LDFLAGS="-L${FLATPAK_DEST}/lib"
        export PATH="${FLATPAK_DEST}/bin:$PATH"
        sed -i 's|prefix  = /usr/local|prefix  = /app|' Makefile.template
        sed -i 's|INCDIRS  =	-I/usr/include -I/usr/local/include|INCDIRS  = -I/app/include|' Makefile.template
        sed -i 's|LIBDIRS  =	-L/usr/local/lib|LIBDIRS  = -L/app/lib|' Makefile.template
        sed -i 's|mandir  = $(prefix)/man/manl|mandir  = /app/man/manl|' Makefile.template
        make linux
        make all
        make install

  # # テスト用のコマンドを追加
  # - name: avs2ps
  #   buildsystem: simple
  #   build-commands:
  #     - echo "#!/bin/sh" > /app/bin/avs2ps
  #     - echo "echo 'outfile.ps'" >> /app/bin/avs2ps
  #     - chmod +x /app/bin/avs2ps

  # - name: ssm
  #   buildsystem: autotools
  #   sources:
  #     - type: archive
  #       url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/ssm-1.4.tar.gz
  #       sha256: 56e7e64ed86d7d9ec59500fd34f26f881bdb9d541916d9a817c3bfb8cf0e9508
  #   build-options:
  #     environment:
  #       CFLAGS: -fPIC
  #   build-commands:
  #     - ./configure --prefix=/app --enable-ccp4 --enable-shared --disable-static
  #     - inreplace ./configure "${wl}-flat_namespace" ""
  #     - inreplace ./configure "${wl}-undefined ${wl}suppress" "-undefined dynamic_lookup"
  #     - make
  #     - make install

  - name: ssm
    buildsystem: autotools
    config-opts:
      - --prefix=/app
      - --enable-ccp4
      - --enable-shared
      - --disable-static
    build-options:
      cflags: "-fPIC"
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/ssm-1.4.tar.gz
        sha256: 56e7e64ed86d7d9ec59500fd34f26f881bdb9d541916d9a817c3bfb8cf0e9508
    build-commands:
      - ./configure --prefix=/app --enable-ccp4 --enable-shared --disable-static
      - make
      - make install

  - name: rdkit
    buildsystem: cmake
    sources:
      - type: archive
        url: https://github.com/rdkit/rdkit/archive/refs/tags/Release_2024_09_1.tar.gz
        sha256: 034c00d6e9de323506834da03400761ed8c3721095114369d06805409747a60f

    build-commands:
      - mkdir build
      - cd build
      - cmake .. \
          -DCMAKE_INSTALL_RPATH=/app/lib \
          -DRDK_INSTALL_INTREE=OFF \
          -DRDK_BUILD_SWIG_WRAPPERS=OFF \
          -DRDK_BUILD_AVALON_SUPPORT=ON \
          -DRDK_BUILD_PGSQL=ON \
          -DRDK_PGSQL_STATIC=ON \
          -DMAEPARSER_FORCE_BUILD=ON \
          -DCOORDGEN_FORCE_BUILD=ON \
          -DRDK_BUILD_INCHI_SUPPORT=ON \
          -DRDK_BUILD_CPP_TESTS=OFF \
          -DRDK_INSTALL_STATIC_LIBS=OFF \
          -DRDK_BUILD_CAIRO_SUPPORT=ON \
          -DRDK_BUILD_YAEHMOP_SUPPORT=ON \
          -DRDK_BUILD_FREESASA_SUPPORT=ON \
          -DBoost_NO_BOOST_CMAKE=ON \
          -DPYTHON_INCLUDE_DIR=/usr/include/python3.12 \
          -DPYTHON_EXECUTABLE=/usr/bin/python3 \
          -DPYTHON_NUMPY_INCLUDE_PATH=/usr/lib/python3/dist-packages/numpy/core/include \
          -DPostgreSQL_CONFIG=/usr/bin/pg_config
      - cmake --build .
      - cmake --install .

    dependencies:
      - boost
      - boost-python3
      - cairo
      - eigen
      - freetype
      - numpy
      - postgresql
      - swig

    # test:
    #   commands:
    #     - /usr/bin/python3 -c "import rdkit"
    #     - |
    #       cat << 'EOF' > test.py
    #       from rdkit import Chem
    #       print(Chem.MolToSmiles(Chem.MolFromSmiles('C1=CC=CN=C1')))
    #       EOF
    #     - /usr/bin/python3 test.py
    #     - |
    #       pg_ctl initdb -D test_db
    #       echo "port = 5432" >> test_db/postgresql.conf
    #       pg_ctl start -D test_db -l logfile
    #       psql -p 5432 -c "CREATE EXTENSION rdkit;" postgres
    #       pg_ctl stop -D test_db


  - name: libdwarf
    buildsystem: simple
    build-commands:
      - if [ "${FLATPAK_BUILDER}" = "true" ]; then sh autogen.sh; fi
      - ./configure --prefix=/app --enable-shared
      - make
      - make install

    sources:
      - type: archive
        url: https://www.prevanders.net/libdwarf-0.11.0.tar.xz
        sha256: 846071fb220ac1952f9f15ebbac6c7831ef50d0369b772c07a8a8139a42e07d2

    build-options:
      environment:
        PKG_CONFIG_PATH: /app/lib/pkgconfig

    test:
      commands:
        - dwarfdump -V
        - |
          cat << 'EOF' > test.c
          #include <dwarf.h>
          #include <libdwarf.h>
          #include <stdio.h>
          #include <string.h>

          int main(void) {
            const char *out = NULL;
            int res = dwarf_get_children_name(0, &out);

            if (res != DW_DLV_OK) {
              printf("Getting name failed\\n");
              return 1;
            }

            if (strcmp(out, "DW_children_no") != 0) {
              printf("Name did not match: %s\\n", out);
              return 1;
            }

            return 0;
          }
          EOF
        - gcc -I/app/include/libdwarf-0 test.c -L/app/lib -ldwarf -o test
        - ./test

  - name: coot
    buildsystem: autotools
    config-opts:
      - --with-enhanced-ligand-tools
      - --with-boost=/app
      - --with-boost-libdir=/app/lib
      - --with-rdkit-prefix=/app
      - --with-fftw-prefix=/app/fftw2
      - --with-backward
      - --with-libdw
      - BOOST_PYTHON_LIB=boost_python312-mt
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/source/releases/coot-1.1.10.tar.gz
        sha256: 447caa7bdd6f87b738d20f8db15aa278476c308e22506004ed145e04f85e0413
      - type: patch
        path: clipper-configure-2.patch
    build-options:
      append-path:
        - /app/lib
        - /app/bin
      environment:
        CXXFLAGS: "-fPIC"
        CPPFLAGS: "-D_USE_BOOST=1"
